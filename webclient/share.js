!function(){function i(t,e){return function(){return t.apply(e,arguments)}}var s,o,n,h,c,e,r,p,l,t,a,u,d,f,g,v,m,y,b,k,_,w,O=[].slice,S=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};function C(){}function E(t,e,n){this.connection=t,this.name=e,this.shout=i(this.shout,this),this.flush=i(this.flush,this),this.version=(n=n||{}).v,this.snapshot=n.snaphot,n.type&&this._setType(n.type),this.state="closed",this.autoOpen=!1,this._create=n.create,this.inflightOp=null,this.inflightCallbacks=[],this.inflightSubmittedIds=[],this.pendingOp=null,this.pendingCallbacks=[],this.serverOps={}}function W(t){this._disconnect=i(this._disconnect,this),this._removeEventListeners=i(this._removeEventListeners,this),this._handleWebsocketError=i(this._handleWebsocketError,this),this._handleWebsocketMessage=i(this._handleWebsocketMessage,this),this._handleWebsocketClose=i(this._handleWebsocketClose,this),this._handleWebsocketOpen=i(this._handleWebsocketOpen,this),this._connect=i(this._connect,this),this._periodicHealthCheck=i(this._periodicHealthCheck,this),this._checkHeartbeat=i(this._checkHeartbeat,this),this._reconnect=i(this._reconnect,this),this.debug=this.debugAll,this.forcedClose=!1,this.url=t,this.readyState=e.CONNECTING,this.URL=t,this.healthCheckInterval=setInterval(this._periodicHealthCheck,1e4),this._connect()}function x(t,e){var n,i,s,o,r;this.docs={},this.state="connecting",t.match(/^wss?:/)&&(f="websocket"),this.socket="sockjs"!==f?new h(t):new h(t,c),this.socket.onmessage=(n=this,function(t){var e;return null===(t="sockjs"!==f&&"websocket"!==f?t:JSON.parse(t.data)).auth?(n.lastError=t.error,n.disconnect(),n.emit("connect failed",t.error)):t.auth?(n.id=t.auth,void n.setState("ok")):(void 0!==(e=t.doc)?n.lastReceivedDoc=e:t.doc=e=n.lastReceivedDoc,n.docs[e]?n.docs[e]._onMessage(t):"undefined"!=typeof console&&null!==console?console.error("Unhandled message",t):void 0)}),this.connected=!1,this.socket.onclose=(i=this,function(t){if(i.setState("disconnected",t),"Closed"===t||"Stopped by server"===t)return i.setState("stopped",i.lastError||t)}),this.socket.onerror=(s=this,function(t){return s.emit("error",t)}),this.socket.onopen=(o=this,function(){return o.send({auth:e||null}),o.lastError=o.lastReceivedDoc=o.lastSentDoc=null,o.setState("handshaking")}),this.socket.onconnecting=(r=this,function(){return r.setState("connecting")})}window.sharejs=t={version:"0.6.3"},d=function(t){return setTimeout(t,0)},C.prototype.on=function(t,e){var n;return this._events||(this._events={}),(n=this._events)[t]||(n[t]=[]),this._events[t].push(e),this},C.prototype.removeListener=function(o,t){var e,n,i,r;for(this._events||(this._events={}),n=(i=this._events)[o]||(i[o]=[]),e=0;e<n.length;)n[e]===t&&(n[e]=void 0),e++;return d((r=this,function(){var s;return r._events[o]=function(){for(var t=this._events[o],e=[],n=0,i=t.length;n<i;n++)(s=t[n])&&e.push(s);return e}.call(r)})),this},C.prototype.emit=function(){var t,e,n,i,s,o=arguments[0],r=2<=arguments.length?O.call(arguments,1):[];if(null!=(i=this._events)&&i[o])for(e=0,n=(s=this._events[o]).length;e<n;e++)(t=s[e])&&t.apply(this,r);return this},C.prototype.once=function(e,n){var i,s;return this.on(e,(s=this,i=function(){var t=1<=arguments.length?O.call(arguments,0):[];return s.removeListener(e,i),n.apply(s,t)}))},(n=C).mixin=function(t){var e=t.prototype||t;return e.on=n.prototype.on,e.removeListener=n.prototype.removeListener,e.emit=n.prototype.emit,e.once=n.prototype.once,t},t._bt=a=function(t,s,_,w){var O,S=function(t,e,n,i){return s(n,t,e,"left"),s(i,e,t,"right")};return t.transformX=t.transformX=O=function(t,e){var n,i,s,o,r,h,c,p,l,a,u,d,f,g,v,m,y,b,k;for(_(t),_(e),r=[],a=0,g=e.length;a<g;a++){for(l=e[a],o=[],n=0;n<t.length;){if(S(t[n],l,o,h=[]),n++,1!==h.length){if(0===h.length){for(u=0,v=(b=t.slice(n)).length;u<v;u++)i=b[u],w(o,i);l=null;break}for(s=(k=O(t.slice(n),h))[0],p=k[1],d=0,m=s.length;d<m;d++)i=s[d],w(o,i);for(f=0,y=p.length;f<y;f++)c=p[f],w(r,c);l=null;break}l=h[0]}null!=l&&w(r,l),t=o}return[t,r]},t.transform=t.transform=function(t,e,n){if("left"!==n&&"right"!==n)throw new Error("type must be 'left' or 'right'");return 0===e.length?t:1===t.length&&1===e.length?s([],t[0],e[0],n):"left"===n?(n=O(t,e)[0],n):((n=O(e,t))[0],n[1])}},g=function(t,e,n){return t.slice(0,e)+n+t.slice(e)},p=function(t){if("number"!=typeof t.p)throw new Error("component missing position field");if(!("string"==typeof t.i^"string"==typeof t.d))throw new Error("component needs an i or d field");if(!(0<=t.p))throw new Error("position cannot be negative")},l=function(t){for(var e,n=0,i=t.length;n<i;n++)e=t[n],p(e);return!0},(v={name:"text",create:function(){return""},apply:function(t,e){var n,i,s,o;for(l(e),s=0,o=e.length;s<o;s++)if(null!=(n=e[s]).i)t=g(t,n.p,n.i);else{if(i=t.slice(n.p,n.p+n.d.length),n.d!==i)throw new Error("Delete component '"+n.d+"' does not match deleted text '"+i+"'");t=t.slice(0,n.p)+t.slice(n.p+n.d.length)}return t}})._append=r=function(t,e){var n,i;if(""!==e.i&&""!==e.d)return 0===t.length?t.push(e):null!=(n=t[t.length-1]).i&&null!=e.i&&n.p<=(i=e.p)&&i<=n.p+n.i.length?t[t.length-1]={i:g(n.i,e.p-n.p,e.i),p:n.p}:null!=n.d&&null!=e.d&&e.p<=(i=n.p)&&i<=e.p+e.d.length?t[t.length-1]={d:g(e.d,n.p-e.p,n.d),p:e.p}:t.push(e)},v.compose=function(t,e){var n,i,s,o;for(l(t),l(e),i=t.slice(),s=0,o=e.length;s<o;s++)n=e[s],r(i,n);return i},v.compress=function(t){return v.compose([],t)},v.normalize=function(t){for(var e,n=[],i=0,s=(t=null==t.i&&null==t.p?t:[t]).length;i<s;i++)null==(e=t[i]).p&&(e.p=0),r(n,e);return n},y=function(t,e,n){return null!=e.i?e.p<t||e.p===t&&n?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length},v.transformCursor=function(t,e,n){for(var i,s="right"===n,o=0,r=e.length;o<r;o++)i=e[o],t=y(t,i,s);return t},v._tc=m=function(t,e,n,i){var s,o;if(l([e]),l([n]),null!=e.i)r(t,{i:e.i,p:y(e.p,n,"right"===i)});else if(null!=n.i)i=e.d,e.p<n.p&&(r(t,{d:i.slice(0,n.p-e.p),p:e.p}),i=i.slice(n.p-e.p)),""!==i&&r(t,{d:i,p:e.p+n.i.length});else if(e.p>=n.p+n.d.length)r(t,{d:e.d,p:e.p-n.d.length});else if(e.p+e.d.length<=n.p)r(t,e);else{if(i={d:"",p:e.p},e.p<n.p&&(i.d=e.d.slice(0,n.p-e.p)),e.p+e.d.length>n.p+n.d.length&&(i.d+=e.d.slice(n.p+n.d.length-e.p)),o=Math.max(e.p,n.p),s=Math.min(e.p+e.d.length,n.p+n.d.length),e.d.slice(o-e.p,s-e.p)!==n.d.slice(o-n.p,s-n.p))throw new Error("Delete ops delete different text in the same region of the document");""!==i.d&&(i.p=y(i.p,n),r(t,i))}return t},u=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}},v.invert=function(t){for(var e,n=t.slice().reverse(),i=[],s=0,o=n.length;s<o;s++)e=n[s],i.push(u(e));return i},t.types||(t.types={}),a(v,m,l,r),(t.types.text=v).api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(t,e,n){t=[{p:t,i:e}];return this.submitOp(t,n),t},del:function(t,e,n){t=[{p:t,d:this.snapshot.slice(t,t+e)}];return this.submitOp(t,n),t},_register:function(){return this.on("remoteop",function(t){for(var e,n=[],i=0,s=t.length;i<s;i++)void 0!==(e=t[i]).i?n.push(this.emit("insert",e.p,e.i)):n.push(this.emit("delete",e.p,e.d));return n})}},t.extendDoc=function(t,e){return o.prototype[t]=e},E.prototype._xf=function(t,e){return this.type.transformX?this.type.transformX(t,e):[this.type.transform(t,e,"left"),this.type.transform(e,t,"right")]},E.prototype._otApply=function(t,e){var n=this.snapshot;if(this.snapshot=this.type.apply(this.snapshot,t),this.emit("change",t,n),e)return this.emit("remoteop",t,n)},E.prototype._connectionStateChanged=function(t,e){switch(t){case"disconnected":this.state="closed",this.inflightOp&&this.inflightSubmittedIds.push(this.connection.id),this.emit("closed");break;case"ok":this.autoOpen&&this.open();break;case"stopped":"function"==typeof this._openCallback&&this._openCallback(e)}return this.emit(t,e)},E.prototype._setType=function(t){var e,n,i;if(!this.type){if(!(t="string"==typeof t?b[t]:t)||!t.compose)throw new Error("Support for types without compose() is not implemented");if((this.type=t).api){for(e in i=t.api)n=i[e],this[e]=n;return"function"==typeof this._register?this._register():void 0}return this.provides={}}},E.prototype._onMessage=function(t){var e,n,i,s,o,r,h,c,p,l,a,u,d,f,g,v,m,y,b;switch(!1){case!0!==t.open:if(this.state="open",this._create=!1,null==this.created&&(this.created=!!t.create),t.type&&this._setType(t.type),t.create?(this.created=!0,this.snapshot=this.type.create()):(!0!==this.created&&(this.created=!1),void 0!==t.snapshot&&(this.snapshot=t.snapshot)),t.meta&&(this.meta=t.meta),null!=t.v&&(this.version=t.v),m=Object.keys(this.serverOps).map(function(t){return parseInt(t)}),s=Math.max.apply(Math,m),o=function(){b=[];for(var t=u=this.version,e=Math.max(s,this.version);u<=e?t<=e:e<=t;u<=e?t++:t--)b.push(t);return b}.apply(this),s>=this.version)for(r=0,p=o.length;r<p;r++)d=o[r],e=this.serverOps[d],null!==this.inflightOp&&(d=this._xf(this.inflightOp,e),this.inflightOp=d[0],e=d[1]),null!==this.pendingOp&&(d=this._xf(this.pendingOp,e),this.pendingOp=d[0],e=d[1]),this.version++,this._otApply(e,!0);return this.inflightOp?(m={doc:this.name,op:this.inflightOp,v:this.version},this.inflightSubmittedIds.length&&(m.dupIfSource=this.inflightSubmittedIds),this.connection.send(m)):this.flush(),this.emit("open"),"function"==typeof this._openCallback?this._openCallback(null):void 0;case!1!==t.open:return t.error&&("undefined"!=typeof console&&null!==console&&console.error("Could not open document: "+t.error),this.emit("error",t.error),"function"==typeof this._openCallback)&&this._openCallback(t.error),this.state="closed",this.emit("closed"),"function"==typeof this._closeCallback&&this._closeCallback(),this._closeCallback=null;case!(null===t.op&&"Op already submitted"===n):break;case!(void 0===t.op&&void 0!==t.v||t.op&&(f=t.meta.source,0<=S.call(this.inflightSubmittedIds,f))):if(i=this.inflightOp,this.inflightOp=null,this.inflightSubmittedIds.length=0,n=t.error)for(this.type.invert?(m=this.type.invert(i),this.pendingOp&&(y=this._xf(this.pendingOp,m),this.pendingOp=y[0],m=y[1]),this._otApply(m,!0)):this.emit("error","Op apply failed ("+n+") and the op could not be reverted"),h=0,l=(g=this.inflightCallbacks).length;h<l;h++)(0,g[h])(n);else{if(t.v!==this.version)throw new Error("Invalid version from server");for(this.serverOps[this.version]=i,this.version++,this.emit("acknowledge",i),c=0,a=(v=this.inflightCallbacks).length;c<a;c++)(0,v[c])(null,i)}return this.flush();case!t.op:if(!(t.v<this.version)){if(t.doc!==this.name)return this.emit("error","Expected docName '"+this.name+"' but got "+t.doc);if(this.serverOps[t.v]=y=t.op,"open"===this.state)return t.v!==this.version?this.emit("error","Expected version "+this.version+" but got "+t.v):(e=y,null!==this.inflightOp&&(m=this._xf(this.inflightOp,e),this.inflightOp=m[0],e=m[1]),null!==this.pendingOp&&(y=this._xf(this.pendingOp,e),this.pendingOp=y[0],e=y[1]),this.version++,this._otApply(e,!0))}break;case!t.meta:return y=(m=t.meta).path,m=m.value,"shout"!==(null!=y?y[0]:void 0)?"undefined"!=typeof console&&null!==console?console.warn("Unhandled meta op:",t):void 0:this.emit("shout",m);default:return"undefined"!=typeof console&&null!==console?console.warn("Unhandled document message:",t):void 0}},E.prototype.flush=function(){if("ok"===this.connection.state&&"open"===this.state&&null===this.inflightOp&&null!==this.pendingOp)return this.inflightOp=this.pendingOp,this.inflightCallbacks=this.pendingCallbacks,this.pendingOp=null,this.pendingCallbacks=[],this.connection.send({doc:this.name,op:this.inflightOp,v:this.version})},E.prototype.submitOp=function(t,e){return null!=this.type.normalize&&(t=this.type.normalize(t)),this.snapshot=this.type.apply(this.snapshot,t),null!==this.pendingOp?this.pendingOp=this.type.compose(this.pendingOp,t):this.pendingOp=t,e&&this.pendingCallbacks.push(e),this.emit("change",t),setTimeout(this.flush,0)},E.prototype.shout=function(t){return this.connection.send({doc:this.name,meta:{path:["shout"],value:t}})},E.prototype.open=function(e){var t,n;if(this.autoOpen=!0,"closed"===this.state)return t={doc:this.name,open:!0},void 0===this.snapshot&&(t.snapshot=null),this.type&&(t.type=this.type.name),null!=this.version&&(t.v=this.version),this._create&&(t.create=!0),this.connection.send(t),this.state="opening",this._openCallback=(n=this,function(t){return n._openCallback=null,"function"==typeof e?e(t):void 0})},E.prototype.close=function(t){return this.autoOpen=!1,"closed"===this.state?"function"==typeof t?t():void 0:(this.connection.send({doc:this.name,open:!1}),this.state="closed",this.emit("closing"),this._closeCallback=t)},o=E,n.mixin(o),t.Doc=o,W.prototype.debugAll=!3,W.prototype.onopen=function(t){},W.prototype.onclose=function(t){},W.prototype.onconnecting=function(t){},W.prototype.onmessage=function(t){},W.prototype.onerror=function(t){},W.prototype.send=function(t){if(this.ws)return this.debug&&console.log("ReconnectingWebSocket","send",this.url,t),this.ws.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},W.prototype.close=function(){if(this.ws)return this.forcedClose=!0,this.ws.close()},W.prototype.refresh=function(){return this.debug&&console.log("ReconnectingWebSocket","refresh"),this._reconnect()},W.prototype._reconnect=function(){return this.debug&&console.log("ReconnectingWebSocket","reconnect"),this.ws&&this.ws.readyState!==e.CLOSED&&this._disconnect(),this._connect()},W.prototype._checkHeartbeat=function(){return 2===this.heartbeatResponse?(this.debug&&console.log("ReconnectingWebSocket","no-heartbeat"),this._reconnect()):(this.heartbeatResponse=2,this.debug&&console.log("ReconnectingWebSocket","send-heartbeat"),this.send(JSON.stringify("heartbeat")))},W.prototype._periodicHealthCheck=function(){switch(this.debug&&console.log("ReconnectingWebSocket","healthcheck"),this.readyState){case e.CLOSED:case e.CONNECTING:return this._reconnect();case e.OPEN:return this._checkHeartbeat()}},W.prototype._connect=function(){return this.ws=new e(this.url),this.readyState=e.CONNECTING,this.debug&&console.log("ReconnectingWebSocket","attempt-connect",this.url),this.ws.addEventListener("open",this._handleWebsocketOpen),this.ws.addEventListener("close",this._handleWebsocketClose),this.ws.addEventListener("message",this._handleWebsocketMessage),this.ws.addEventListener("error",this._handleWebsocketError)},W.prototype._handleWebsocketOpen=function(t){return this.debug&&console.log("ReconnectingWebSocket","onopen",this.url),this.readyState=e.OPEN,this.heartbeatResponse=1,this.onopen(t)},W.prototype._handleWebsocketClose=function(t){if(this.ws=null,this.readyState=e.CLOSED,this.onclose(t),this.forcedClose)return clearInterval(this.healthCheckInterval)},W.prototype._handleWebsocketMessage=function(t){var e=JSON.parse(t.data);return this.debug&&console.log("ReconnectingWebSocket","onmessage",this.url,t.data),e.heartbeat?(this.debug&&console.log("ReconnectingWebSocket","heartbeat-received",e.heartbeat),this.heartbeatResponse=3):this.onmessage(t)},W.prototype._handleWebsocketError=function(t){return this.debug&&console.log("ReconnectingWebSocket","onerror",this.url,t),this.onerror(t)},W.prototype._removeEventListeners=function(){if(this.debug&&console.log("ReconnectingWebSocket","remove-event-listeners"),this.ws)return this.ws.removeEventListener("open",this._handleWebsocketOpen),this.ws.removeEventListener("close",this._handleWebsocketClose),this.ws.removeEventListener("message",this._handleWebsocketMessage),this.ws.removeEventListener("error",this._handleWebsocketError)},W.prototype._disconnect=function(){if(this.debug&&console.log("ReconnectingWebSocket","disconnect"),this.ws)return this._removeEventListeners(),this.ws.close(),this.readyState=e.CLOSED,this.onclose({target:this,type:"disconnect"})},h=W,b=t.types,c=window.SockJS,e=window.WebSocket,f=c?"sockjs":"websocket",x.prototype.setState=function(t,e){var n,i,s,o;if(this.state!==t){for(i in"disconnected"===(this.state=t)&&delete this.id,this.emit(t,e),o=[],s=this.docs)n=s[i],o.push(n._connectionStateChanged(t,e));return o}},x.prototype.send=function(t){var e;return t.doc&&((e=t.doc)===this.lastSentDoc?delete t.doc:this.lastSentDoc=e),"sockjs"!==f&&"websocket"!==f||(t=JSON.stringify(t)),this.socket.send(t)},x.prototype.disconnect=function(){return this.socket.close()},x.prototype.makeDoc=function(e,t,n){var i,s;if(this.docs[e])throw new Error("Doc "+e+" already open");return i=new o(this,e,t),(this.docs[e]=i).open((s=this,function(t){return t&&delete s.docs[e],t||i.on("closed",function(){if(!i.autoOpen)return delete s.docs[e]}),n(t,t?void 0:i)}))},x.prototype.openExisting=function(t,e){return"stopped"===this.state?e("connection closed"):this.docs[t]?this._ensureOpenState(this.docs[t],e):this.makeDoc(t,{},e)},x.prototype.open=function(t,e,n){var i;if("stopped"===this.state)return n("connection closed");if("connecting"===this.state)this.on("handshaking",function(){return this.open(t,e,n),n=null});else{if("function"==typeof e&&(n=e,e="text"),n=n||function(){},!(e="string"==typeof e?b[e]:e))throw new Error("OT code for document type missing");if(null==t)throw new Error("Server-generated random doc names are not currently supported");if(!this.docs[t])return this.makeDoc(t,{create:!0,type:e.name},n);(i=this.docs[t]).type===e?this._ensureOpenState(i,n):n("Type mismatch",i)}},x.prototype._ensureOpenState=function(e,n){switch(e.state){case"open":n(null,e);break;case"opening":this.on("open",function(){return n(null,e)});break;case"closed":e.open(function(t){return n(t,t?void 0:e)})}},s=x,n.mixin(s),t.Connection=s,a=void 0!==window.BCSocket,f=a?"channel":void 0!==window.SockJS?"sockjs":"websocket",t.open=(k={},_=function(t,e){var n,i;return null==t&&(n=window.location,i="websocket"===f?"ws:":n.protocol,t=i+"//"+n.host+"/"+f),k[t]||((i=new s(t,e)).on("disconnected",n=function(){return delete k[t]}),i.on("connect failed",n),k[t]=i),k[t]},w=function(t){var e,n,i=0,s=t.docs;for(n in s)"closed"===(e=s[n]).state&&!e.autoOpen||i++;if(0===i)return t.disconnect()},function(t,e,n,i){var s,o;return"function"==typeof n&&(i=n,n={}),o=(n="string"==typeof n?{origin:n}:n).origin,n=n.authentication,(s=_(o,n)).open(t,e,function(t,e){return t?(i(t),w(s)):(e.on("closed",function(){return w(s)}),i(null,e))}),s.on("connect failed"),s})}.call(this);