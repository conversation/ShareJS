(function(){var BCSocket,Connection,Doc,MicroEvent,ReconnectingWebSocket,SockJS,WebSocket,append,bootstrapTransform,checkValidComponent,checkValidOp,exports,hasBCSocket,hasSockJS,invertComponent,nextTick,socketImpl,strInject,text,transformComponent,transformPosition,types,__slice=[].slice,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};window.sharejs=exports={version:"0.6.3"},typeof WEB=="undefined"&&(window.WEB=!0),nextTick=typeof WEB!="undefined"&&WEB!==null?function(fn){return setTimeout(fn,0)}:process.nextTick,MicroEvent=function(){function MicroEvent(){}return MicroEvent.prototype.on=function(event,f){var _base;return this._events||(this._events={}),(_base=this._events)[event]||(_base[event]=[]),this._events[event].push(f),this},MicroEvent.prototype.removeListener=function(event,fct){var i,listeners,_base;this._events||(this._events={}),listeners=(_base=this._events)[event]||(_base[event]=[]),i=0;while(i<listeners.length)listeners[i]===fct&&(listeners[i]=void 0),i++;return nextTick(function(_this){return function(){var x;return _this._events[event]=function(){var _i,_len,_ref,_results;_ref=this._events[event],_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)x=_ref[_i],x&&_results.push(x);return _results}.call(_this)}}(this)),this},MicroEvent.prototype.emit=function(){var args,event,fn,_i,_len,_ref,_ref1;event=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if((_ref=this._events)!=null?!_ref[event]:!void 0)return this;_ref1=this._events[event];for(_i=0,_len=_ref1.length;_i<_len;_i++)fn=_ref1[_i],fn&&fn.apply(this,args);return this},MicroEvent.prototype.once=function(event,f){var listener;return this.on(event,listener=function(_this){return function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],_this.removeListener(event,listener),f.apply(_this,args)}}(this))},MicroEvent}(),MicroEvent.mixin=function(obj){var proto;return proto=obj.prototype||obj,proto.on=MicroEvent.prototype.on,proto.removeListener=MicroEvent.prototype.removeListener,proto.emit=MicroEvent.prototype.emit,proto.once=MicroEvent.prototype.once,obj};if(typeof WEB=="undefined"||WEB===null)module.exports=MicroEvent;exports._bt=bootstrapTransform=function(type,transformComponent,checkValidOp,append){var transformComponentX,transformX;return transformComponentX=function(left,right,destLeft,destRight){return transformComponent(destLeft,left,right,"left"),transformComponent(destRight,right,left,"right")},type.transformX=type.transformX=transformX=function(leftOp,rightOp){var k,l,l_,newLeftOp,newRightOp,nextC,r,r_,rightComponent,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1;checkValidOp(leftOp),checkValidOp(rightOp),newRightOp=[];for(_i=0,_len=rightOp.length;_i<_len;_i++){rightComponent=rightOp[_i],newLeftOp=[],k=0;while(k<leftOp.length){nextC=[],transformComponentX(leftOp[k],rightComponent,newLeftOp,nextC),k++;if(nextC.length!==1){if(nextC.length===0){_ref=leftOp.slice(k);for(_j=0,_len1=_ref.length;_j<_len1;_j++)l=_ref[_j],append(newLeftOp,l);rightComponent=null;break}_ref1=transformX(leftOp.slice(k),nextC),l_=_ref1[0],r_=_ref1[1];for(_k=0,_len2=l_.length;_k<_len2;_k++)l=l_[_k],append(newLeftOp,l);for(_l=0,_len3=r_.length;_l<_len3;_l++)r=r_[_l],append(newRightOp,r);rightComponent=null;break}rightComponent=nextC[0]}rightComponent!=null&&append(newRightOp,rightComponent),leftOp=newLeftOp}return[leftOp,newRightOp]},type.transform=type.transform=function(op,otherOp,type){var left,right,_,_ref,_ref1;if(type!=="left"&&type!=="right")throw new Error("type must be 'left' or 'right'");return otherOp.length===0?op:op.length===1&&otherOp.length===1?transformComponent([],op[0],otherOp[0],type):type==="left"?(_ref=transformX(op,otherOp),left=_ref[0],_=_ref[1],left):(_ref1=transformX(otherOp,op),_=_ref1[0],right=_ref1[1],right)}},typeof WEB=="undefined"&&(exports.bootstrapTransform=bootstrapTransform),text={},text.name="text",text.create=function(){return""},strInject=function(s1,pos,s2){return s1.slice(0,pos)+s2+s1.slice(pos)},checkValidComponent=function(c){var d_type,i_type;if(typeof c.p!="number")throw new Error("component missing position field");i_type=typeof c.i,d_type=typeof c.d;if(!(i_type==="string"^d_type==="string"))throw new Error("component needs an i or d field");if(!(c.p>=0))throw new Error("position cannot be negative")},checkValidOp=function(op){var c,_i,_len;for(_i=0,_len=op.length;_i<_len;_i++)c=op[_i],checkValidComponent(c);return!0},text.apply=function(snapshot,op){var component,deleted,_i,_len;checkValidOp(op);for(_i=0,_len=op.length;_i<_len;_i++){component=op[_i];if(component.i!=null)snapshot=strInject(snapshot,component.p,component.i);else{deleted=snapshot.slice(component.p,component.p+component.d.length);if(component.d!==deleted)throw new Error("Delete component '"+component.d+"' does not match deleted text '"+deleted+"'");snapshot=snapshot.slice(0,component.p)+snapshot.slice(component.p+component.d.length)}}return snapshot},text._append=append=function(newOp,c){var last,_ref,_ref1;if(c.i===""||c.d==="")return;return newOp.length===0?newOp.push(c):(last=newOp[newOp.length-1],last.i!=null&&c.i!=null&&last.p<=(_ref=c.p)&&_ref<=last.p+last.i.length?newOp[newOp.length-1]={i:strInject(last.i,c.p-last.p,c.i),p:last.p}:last.d!=null&&c.d!=null&&c.p<=(_ref1=last.p)&&_ref1<=c.p+c.d.length?newOp[newOp.length-1]={d:strInject(c.d,last.p-c.p,last.d),p:c.p}:newOp.push(c))},text.compose=function(op1,op2){var c,newOp,_i,_len;checkValidOp(op1),checkValidOp(op2),newOp=op1.slice();for(_i=0,_len=op2.length;_i<_len;_i++)c=op2[_i],append(newOp,c);return newOp},text.compress=function(op){return text.compose([],op)},text.normalize=function(op){var c,newOp,_i,_len;newOp=[];if(op.i!=null||op.p!=null)op=[op];for(_i=0,_len=op.length;_i<_len;_i++)c=op[_i],c.p==null&&(c.p=0),append(newOp,c);return newOp},transformPosition=function(pos,c,insertAfter){return c.i!=null?c.p<pos||c.p===pos&&insertAfter?pos+c.i.length:pos:pos<=c.p?pos:pos<=c.p+c.d.length?c.p:pos-c.d.length},text.transformCursor=function(position,op,side){var c,insertAfter,_i,_len;insertAfter=side==="right";for(_i=0,_len=op.length;_i<_len;_i++)c=op[_i],position=transformPosition(position,c,insertAfter);return position},text._tc=transformComponent=function(dest,c,otherC,side){var cIntersect,intersectEnd,intersectStart,newC,otherIntersect,s;checkValidOp([c]),checkValidOp([otherC]);if(c.i!=null)append(dest,{i:c.i,p:transformPosition(c.p,otherC,side==="right")});else if(otherC.i!=null)s=c.d,c.p<otherC.p&&(append(dest,{d:s.slice(0,otherC.p-c.p),p:c.p}),s=s.slice(otherC.p-c.p)),s!==""&&append(dest,{d:s,p:c.p+otherC.i.length});else if(c.p>=otherC.p+otherC.d.length)append(dest,{d:c.d,p:c.p-otherC.d.length});else if(c.p+c.d.length<=otherC.p)append(dest,c);else{newC={d:"",p:c.p},c.p<otherC.p&&(newC.d=c.d.slice(0,otherC.p-c.p)),c.p+c.d.length>otherC.p+otherC.d.length&&(newC.d+=c.d.slice(otherC.p+otherC.d.length-c.p)),intersectStart=Math.max(c.p,otherC.p),intersectEnd=Math.min(c.p+c.d.length,otherC.p+otherC.d.length),cIntersect=c.d.slice(intersectStart-c.p,intersectEnd-c.p),otherIntersect=otherC.d.slice(intersectStart-otherC.p,intersectEnd-otherC.p);if(cIntersect!==otherIntersect)throw new Error("Delete ops delete different text in the same region of the document");newC.d!==""&&(newC.p=transformPosition(newC.p,otherC),append(dest,newC))}return dest},invertComponent=function(c){return c.i!=null?{d:c.i,p:c.p}:{i:c.d,p:c.p}},text.invert=function(op){var c,_i,_len,_ref,_results;_ref=op.slice().reverse(),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)c=_ref[_i],_results.push(invertComponent(c));return _results},typeof WEB!="undefined"&&WEB!==null?(exports.types||(exports.types={}),bootstrapTransform(text,transformComponent,checkValidOp,append),exports.types.text=text):(module.exports=text,require("./helpers").bootstrapTransform(text,transformComponent,checkValidOp,append)),typeof WEB=="undefined"&&(text=require("./text")),text.api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(pos,text,callback){var op;return op=[{p:pos,i:text}],this.submitOp(op,callback),op},del:function(pos,length,callback){var op;return op=[{p:pos,d:this.snapshot.slice(pos,pos+length)}],this.submitOp(op,callback),op},_register:function(){return this.on("remoteop",function(op){var component,_i,_len,_results;_results=[];for(_i=0,_len=op.length;_i<_len;_i++)component=op[_i],component.i!==void 0?_results.push(this.emit("insert",component.p,component.i)):_results.push(this.emit("delete",component.p,component.d));return _results})}};if(typeof WEB=="undefined"||WEB===null)types=require("../types");typeof WEB!="undefined"&&WEB!==null&&(exports.extendDoc=function(name,fn){return Doc.prototype[name]=fn}),Doc=function(){function Doc(connection,name,openData){this.connection=connection,this.name=name,this.shout=__bind(this.shout,this),this.flush=__bind(this.flush,this),openData||(openData={}),this.version=openData.v,this.snapshot=openData.snaphot,openData.type&&this._setType(openData.type),this.state="closed",this.autoOpen=!1,this._create=openData.create,this.inflightOp=null,this.inflightCallbacks=[],this.inflightSubmittedIds=[],this.pendingOp=null,this.pendingCallbacks=[],this.serverOps={}}return Doc.prototype._xf=function(client,server){var client_,server_;return this.type.transformX?this.type.transformX(client,server):(client_=this.type.transform(client,server,"left"),server_=this.type.transform(server,client,"right"),[client_,server_])},Doc.prototype._otApply=function(docOp,isRemote){var oldSnapshot;oldSnapshot=this.snapshot,this.snapshot=this.type.apply(this.snapshot,docOp),this.emit("change",docOp,oldSnapshot);if(isRemote)return this.emit("remoteop",docOp,oldSnapshot)},Doc.prototype._connectionStateChanged=function(state,data){switch(state){case"disconnected":this.state="closed",this.inflightOp&&this.inflightSubmittedIds.push(this.connection.id),this.emit("closed");break;case"ok":this.autoOpen&&this.open();break;case"stopped":typeof this._openCallback=="function"&&this._openCallback(data)}return this.emit(state,data)},Doc.prototype._setType=function(type){var k,v,_ref;if(this.type)return;typeof type=="string"&&(type=types[type]);if(!type||!type.compose)throw new Error("Support for types without compose() is not implemented");this.type=type;if(type.api){_ref=type.api;for(k in _ref)v=_ref[k],this[k]=v;return typeof this._register=="function"?this._register():void 0}return this.provides={}},Doc.prototype._onMessage=function(msg){var callback,docOp,error,oldInflightOp,op,path,response,undo,value,_i,_j,_len,_len1,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6;switch(!1){case msg.open!==!0:return this.state="open",this._create=!1,this.created==null&&(this.created=!!msg.create),msg.type&&this._setType(msg.type),msg.create?(this.created=!0,this.snapshot=this.type.create()):(this.created!==!0&&(this.created=!1),msg.snapshot!==void 0&&(this.snapshot=msg.snapshot)),msg.meta&&(this.meta=msg.meta),msg.v!=null&&(this.version=msg.v),this.inflightOp?(response={doc:this.name,op:this.inflightOp,v:this.version},this.inflightSubmittedIds.length&&(response.dupIfSource=this.inflightSubmittedIds),this.connection.send(response)):this.flush(),this.emit("open"),typeof this._openCallback=="function"?this._openCallback(null):void 0;case msg.open!==!1:return msg.error&&(typeof console!="undefined"&&console!==null&&console.error("Could not open document: "+msg.error),this.emit("error",msg.error),typeof this._openCallback=="function"&&this._openCallback(msg.error)),this.state="closed",this.emit("closed"),typeof this._closeCallback=="function"&&this._closeCallback(),this._closeCallback=null;case msg.op!==null||error!=="Op already submitted":break;case!(msg.op===void 0&&msg.v!==void 0||msg.op&&(_ref=msg.meta.source,__indexOf.call(this.inflightSubmittedIds,_ref)>=0)):oldInflightOp=this.inflightOp,this.inflightOp=null,this.inflightSubmittedIds.length=0,error=msg.error;if(error){this.type.invert?(undo=this.type.invert(oldInflightOp),this.pendingOp&&(_ref1=this._xf(this.pendingOp,undo),this.pendingOp=_ref1[0],undo=_ref1[1]),this._otApply(undo,!0)):this.emit("error","Op apply failed ("+error+") and the op could not be reverted"),_ref2=this.inflightCallbacks;for(_i=0,_len=_ref2.length;_i<_len;_i++)callback=_ref2[_i],callback(error)}else{if(msg.v!==this.version)throw new Error("Invalid version from server");this.serverOps[this.version]=oldInflightOp,this.version++,this.emit("acknowledge",oldInflightOp),_ref3=this.inflightCallbacks;for(_j=0,_len1=_ref3.length;_j<_len1;_j++)callback=_ref3[_j],callback(null,oldInflightOp)}return this.flush();case!msg.op:if(msg.v<this.version)return;if(msg.doc!==this.name)return this.emit("error","Expected docName '"+this.name+"' but got "+msg.doc);if(msg.v!==this.version)return this.emit("error","Expected version "+this.version+" but got "+msg.v);return op=msg.op,this.serverOps[this.version]=op,docOp=op,this.inflightOp!==null&&(_ref4=this._xf(this.inflightOp,docOp),this.inflightOp=_ref4[0],docOp=_ref4[1]),this.pendingOp!==null&&(_ref5=this._xf(this.pendingOp,docOp),this.pendingOp=_ref5[0],docOp=_ref5[1]),this.version++,this._otApply(docOp,!0);case!msg.meta:_ref6=msg.meta,path=_ref6.path,value=_ref6.value;switch(path!=null?path[0]:void 0){case"shout":return this.emit("shout",value);default:return typeof console!="undefined"&&console!==null?console.warn("Unhandled meta op:",msg):void 0}break;default:return typeof console!="undefined"&&console!==null?console.warn("Unhandled document message:",msg):void 0}},Doc.prototype.flush=function(){if(this.connection.state!=="ok"||this.inflightOp!==null||this.pendingOp===null)return;return this.inflightOp=this.pendingOp,this.inflightCallbacks=this.pendingCallbacks,this.pendingOp=null,this.pendingCallbacks=[],this.connection.send({doc:this.name,op:this.inflightOp,v:this.version})},Doc.prototype.submitOp=function(op,callback){return this.type.normalize!=null&&(op=this.type.normalize(op)),this.snapshot=this.type.apply(this.snapshot,op),this.pendingOp!==null?this.pendingOp=this.type.compose(this.pendingOp,op):this.pendingOp=op,callback&&this.pendingCallbacks.push(callback),this.emit("change",op),setTimeout(this.flush,0)},Doc.prototype.shout=function(msg){return this.connection.send({doc:this.name,meta:{path:["shout"],value:msg}})},Doc.prototype.open=function(callback){var message;this.autoOpen=!0;if(this.state!=="closed")return;return message={doc:this.name,open:!0},this.snapshot===void 0&&(message.snapshot=null),this.type&&(message.type=this.type.name),this.version!=null&&(message.v=this.version),this._create&&(message.create=!0),this.connection.send(message),this.state="opening",this._openCallback=function(_this){return function(error){return _this._openCallback=null,typeof callback=="function"?callback(error):void 0}}(this)},Doc.prototype.close=function(callback){return this.autoOpen=!1,this.state==="closed"?typeof callback=="function"?callback():void 0:(this.connection.send({doc:this.name,open:!1}),this.state="closed",this.emit("closing"),this._closeCallback=callback)},Doc}();if(typeof WEB=="undefined"||WEB===null)MicroEvent=require("./microevent");MicroEvent.mixin(Doc),exports.Doc=Doc,ReconnectingWebSocket=function(){function ReconnectingWebSocket(url,protocols,Socket){var connect,timedOut;protocols!=null&&typeof protocols=="function"?(Socket=protocols,protocols=void 0):typeof Socket!="function"&&(Socket=WebSocket),this.debug=this.debugAll,this.reconnectInterval=1e3,this.timeoutInterval=2e3,this.forcedClose=!1,this.url=url,this.protocols=protocols,this.readyState=Socket.CONNECTING,this.URL=url,timedOut=!1,connect=function(_this){return function(reconnectAttempt){var timeout;return _this.ws=new Socket(_this.url),_this.debug&&console.debug("ReconnectingWebSocket","attempt-connect",_this.url),timeout=setTimeout(function(){return _this.debug&&console.debug("ReconnectingWebSocket","connection-timeout",_this.url),timedOut=!0,_this.ws.close(),timedOut=!1},_this.timeoutInterval),_this.ws.onopen=function(event){return clearTimeout(timeout),_this.debug&&console.debug("ReconnectingWebSocket","onopen",_this.url),_this.readyState=Socket.OPEN,reconnectAttempt=!1,_this.onopen(event)},_this.ws.onclose=function(event){return clearTimeout(timeout),_this.ws=null,_this.forcedClose?(_this.readyState=Socket.CLOSED,_this.onclose(event)):(_this.readyState=Socket.CONNECTING,_this.onconnecting(event),!reconnectAttempt&&!timedOut&&(_this.debug&&console.debug("ReconnectingWebSocket","onclose",_this.url),_this.onclose(event)),setTimeout(function(){return connect(!0)},_this.reconnectInterval))},_this.ws.onmessage=function(event){return _this.debug&&console.debug("ReconnectingWebSocket","onmessage",_this.url,event.data),_this.onmessage(event)},_this.ws.onerror=function(event){return _this.debug&&console.debug("ReconnectingWebSocket","onerror",_this.url,event),_this.onerror(event)}}}(this),connect(this.url)}return ReconnectingWebSocket.prototype.onopen=function(event){},ReconnectingWebSocket.prototype.onclose=function(event){},ReconnectingWebSocket.prototype.onconnecting=function(event){},ReconnectingWebSocket.prototype.onmessage=function(event){},ReconnectingWebSocket.prototype.onerror=function(event){},ReconnectingWebSocket.prototype.send=function(data){if(this.ws)return this.debug&&console.debug("ReconnectingWebSocket","send",this.url,data),this.ws.send(data);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},ReconnectingWebSocket.prototype.close=function(){if(this.ws)return this.forcedClose=!0,this.ws.close()},ReconnectingWebSocket.prototype.debugAll=!1,ReconnectingWebSocket.prototype.refresh=function(){if(this.ws)return this.ws.close()},ReconnectingWebSocket}(),typeof WEB!="undefined"&&WEB!==null?(types=exports.types,BCSocket=window.BCSocket,SockJS=window.SockJS,WebSocket=window.WebSocket,BCSocket?socketImpl="channel":SockJS?socketImpl="sockjs":socketImpl="websocket"):(types=require("../types"),BCSocket=require("browserchannel").BCSocket,Doc=require("./doc").Doc,WebSocket=require("ws"),socketImpl=null),Connection=function(){function Connection(host,authentication){this.docs={},this.state="connecting",socketImpl==null&&host.match(/^ws:/)&&(socketImpl="websocket"),this.socket=function(){switch(socketImpl){case"channel":return new BCSocket(host,{reconnect:!0});case"sockjs":return new ReconnectingWebSocket(host,SockJS);case"websocket":return new ReconnectingWebSocket(host);default:return new BCSocket(host,{reconnect:!0})}}(),this.socket.onmessage=function(_this){return function(msg){var docName;if(socketImpl==="sockjs"||socketImpl==="websocket")msg=JSON.parse(msg.data);if(msg.auth===null)return _this.lastError=msg.error,_this.disconnect(),_this.emit("connect failed",msg.error);if(msg.auth){_this.id=msg.auth,_this.setState("ok");return}return docName=msg.doc,docName!==void 0?_this.lastReceivedDoc=docName:msg.doc=docName=_this.lastReceivedDoc,_this.docs[docName]?_this.docs[docName]._onMessage(msg):typeof console!="undefined"&&console!==null?console.error("Unhandled message",msg):void 0}}(this),this.connected=!1,this.socket.onclose=function(_this){return function(reason){_this.setState("disconnected",reason);if(reason==="Closed"||reason==="Stopped by server")return _this.setState("stopped",_this.lastError||reason)}}(this),this.socket.onerror=function(_this){return function(e){return _this.emit("error",e)}}(this),this.socket.onopen=function(_this){return function(){return _this.send({auth:authentication?authentication:null}),_this.lastError=_this.lastReceivedDoc=_this.lastSentDoc=null,_this.setState("handshaking")}}(this),this.socket.onconnecting=function(_this){return function(){return _this.setState("connecting")}}(this)}return Connection.prototype.setState=function(state,data){var doc,docName,_ref,_results;if(this.state===state)return;this.state=state,state==="disconnected"&&delete this.id,this.emit(state,data),_ref=this.docs,_results=[];for(docName in _ref)doc=_ref[docName],_results.push(doc._connectionStateChanged(state,data));return _results},Connection.prototype.send=function(data){var docName;data.doc&&(docName=data.doc,docName===this.lastSentDoc?delete data.doc:this.lastSentDoc=docName);if(socketImpl==="sockjs"||socketImpl==="websocket")data=JSON.stringify(data);return this.socket.send(data)},Connection.prototype.disconnect=function(){return this.socket.close()},Connection.prototype.makeDoc=function(name,data,callback){var doc;if(this.docs[name])throw new Error("Doc "+name+" already open");return doc=new Doc(this,name,data),this.docs[name]=doc,doc.open(function(_this){return function(error){return error&&delete _this.docs[name],error||doc.on("closed",function(){if(!doc.autoOpen)return delete _this.docs[name]}),callback(error,error?void 0:doc)}}(this))},Connection.prototype.openExisting=function(docName,callback){var doc;return this.state==="stopped"?callback("connection closed"):this.docs[docName]?this._ensureOpenState(this.docs[docName],callback):doc=this.makeDoc(docName,{},callback)},Connection.prototype.open=function(docName,type,callback){var doc;if(this.state==="stopped")return callback("connection closed");if(this.state==="connecting"){this.on("handshaking",function(){return this.open(docName,type,callback),callback=null});return}typeof type=="function"&&(callback=type,type="text"),callback||(callback=function(){}),typeof type=="string"&&(type=types[type]);if(!type)throw new Error("OT code for document type missing");if(docName==null)throw new Error("Server-generated random doc names are not currently supported");if(this.docs[docName]){doc=this.docs[docName],doc.type===type?this._ensureOpenState(doc,callback):callback("Type mismatch",doc);return}return this.makeDoc(docName,{create:!0,type:type.name},callback)},Connection.prototype._ensureOpenState=function(doc,callback){switch(doc.state){case"open":callback(null,doc);break;case"opening":this.on("open",function(){return callback(null,doc)});break;case"closed":doc.open(function(error){return callback(error,error?void 0:doc)})}},Connection}();if(typeof WEB=="undefined"||WEB===null)MicroEvent=require("./microevent");MicroEvent.mixin(Connection),exports.Connection=Connection,typeof WEB!="undefined"&&WEB!==null?(hasBCSocket=window.BCSocket!==void 0,hasSockJS=window.SockJS!==void 0,hasBCSocket?socketImpl="channel":hasSockJS?socketImpl="sockjs":socketImpl="websocket"):Connection=require("./connection").Connection,exports.open=function(){var connections,getConnection,maybeClose;return connections={},getConnection=function(origin,authentication){var c,del,location,protocol;return typeof WEB!="undefined"&&WEB!==null&&origin==null&&(location=window.location,protocol=socketImpl==="websocket"?"ws:":location.protocol,origin=""+protocol+"//"+location.host+"/"+socketImpl),connections[origin]||(c=new Connection(origin,authentication),del=function(){return delete connections[origin]},c.on("disconnected",del),c.on("connect failed",del),connections[origin]=c),connections[origin]},maybeClose=function(c){var doc,name,numDocs,_ref;numDocs=0,_ref=c.docs;for(name in _ref)doc=_ref[name],(doc.state!=="closed"||doc.autoOpen)&&numDocs++;if(numDocs===0)return c.disconnect()},function(docName,type,options,callback){var authentication,c,origin;return typeof options=="function"&&(callback=options,options={}),typeof options=="string"&&(options={origin:options}),origin=options.origin,authentication=options.authentication,c=getConnection(origin,authentication),c.open(docName,type,function(error,doc){return error?(callback(error),maybeClose(c)):(doc.on("closed",function(){return maybeClose(c)}),callback(null,doc))}),c.on("connect failed"),c}}();if(typeof WEB=="undefined"||WEB===null)exports.Doc=require("./doc").Doc,exports.Connection=require("./connection").Connection}).call(this)