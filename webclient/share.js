(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=[].slice,T=function(e,t){return function(){return e.apply(t,arguments)}},N=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};window.sharejs=h={version:"0.6.3"},m=function(e){return setTimeout(e,0)},i=function(){function e(){}return e.prototype.on=function(e,t){var n;return this._events||(this._events={}),(n=this._events)[e]||(n[e]=[]),this._events[e].push(t),this},e.prototype.removeListener=function(e,t){var n,r,i;this._events||(this._events={}),r=(i=this._events)[e]||(i[e]=[]),n=0;while(n<r.length)r[n]===t&&(r[n]=void 0),n++;return m(function(t){return function(){var n;return t._events[e]=function(){var t,r,i=this._events[e],s=[];for(t=0,r=i.length;t<r;t++)n=i[t],n&&s.push(n);return s}.call(t)}}(this)),this},e.prototype.emit=function(){var e,t,n,r,i,s=arguments[0],o=2<=arguments.length?x.call(arguments,1):[];if((r=this._events)!=null?!r[s]:!void 0)return this;i=this._events[s];for(t=0,n=i.length;t<n;t++)e=i[t],e&&e.apply(this,o);return this},e.prototype.once=function(e,t){var n;return this.on(e,n=function(r){return function(){var i=1<=arguments.length?x.call(arguments,0):[];return r.removeListener(e,n),t.apply(r,i)}}(this))},e}(),i.mixin=function(e){var t=e.prototype||e;return t.on=i.prototype.on,t.removeListener=i.prototype.removeListener,t.emit=i.prototype.emit,t.once=i.prototype.once,e},h._bt=f=function(e,t,n,r){var i,s=function(e,n,r,i){return t(r,e,n,"left"),t(i,n,e,"right")};return e.transformX=e.transformX=i=function(e,t){var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;n(e),n(t),l=[];for(v=0,b=t.length;v<b;v++){d=t[v],f=[],o=0;while(o<e.length){c=[],s(e[o],d,f,c),o++;if(c.length!==1){if(c.length===0){x=e.slice(o);for(m=0,w=x.length;m<w;m++)u=x[m],r(f,u);d=null;break}T=i(e.slice(o),c),a=T[0],p=T[1];for(g=0,E=a.length;g<E;g++)u=a[g],r(f,u);for(y=0,S=p.length;y<S;y++)h=p[y],r(l,h);d=null;break}d=c[0]}d!=null&&r(l,d),e=f}return[e,l]},e.transform=e.transform=function(e,n,r){var s,o,u,a,f;if(r!=="left"&&r!=="right")throw new Error("type must be 'left' or 'right'");return n.length===0?e:e.length===1&&n.length===1?t([],e[0],n[0],r):r==="left"?(a=i(e,n),s=a[0],u=a[1],s):(f=i(n,e),u=f[0],o=f[1],o)}},b={},b.name="text",b.create=function(){return""},y=function(e,t,n){return e.slice(0,t)+n+e.slice(t)},l=function(e){var t,n;if(typeof e.p!="number")throw new Error("component missing position field");n=typeof e.i,t=typeof e.d;if(!(n==="string"^t==="string"))throw new Error("component needs an i or d field");if(!(e.p>=0))throw new Error("position cannot be negative")},c=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++)t=e[n],l(t);return!0},b.apply=function(e,t){var n,r,i,s;c(t);for(i=0,s=t.length;i<s;i++){n=t[i];if(n.i!=null)e=y(e,n.p,n.i);else{r=e.slice(n.p,n.p+n.d.length);if(n.d!==r)throw new Error("Delete component '"+n.d+"' does not match deleted text '"+r+"'");e=e.slice(0,n.p)+e.slice(n.p+n.d.length)}}return e},b._append=a=function(e,t){var n,r,i;if(t.i===""||t.d==="")return;return e.length===0?e.push(t):(n=e[e.length-1],n.i!=null&&t.i!=null&&n.p<=(r=t.p)&&r<=n.p+n.i.length?e[e.length-1]={i:y(n.i,t.p-n.p,t.i),p:n.p}:n.d!=null&&t.d!=null&&t.p<=(i=n.p)&&i<=t.p+t.d.length?e[e.length-1]={d:y(t.d,n.p-t.p,n.d),p:t.p}:e.push(t))},b.compose=function(e,t){var n,r,i,s;c(e),c(t),r=e.slice();for(i=0,s=t.length;i<s;i++)n=t[i],a(r,n);return r},b.compress=function(e){return b.compose([],e)},b.normalize=function(e){var t,n,r,i=[];if(e.i!=null||e.p!=null)e=[e];for(n=0,r=e.length;n<r;n++)t=e[n],t.p==null&&(t.p=0),a(i,t);return i},E=function(e,t,n){return t.i!=null?t.p<e||t.p===e&&n?e+t.i.length:e:e<=t.p?e:e<=t.p+t.d.length?t.p:e-t.d.length},b.transformCursor=function(e,t,n){var r,i,s,o=n==="right";for(i=0,s=t.length;i<s;i++)r=t[i],e=E(e,r,o);return e},b._tc=w=function(e,t,n,r){var i,s,o,u,f,l;c([t]),c([n]);if(t.i!=null)a(e,{i:t.i,p:E(t.p,n,r==="right")});else if(n.i!=null)l=t.d,t.p<n.p&&(a(e,{d:l.slice(0,n.p-t.p),p:t.p}),l=l.slice(n.p-t.p)),l!==""&&a(e,{d:l,p:t.p+n.i.length});else if(t.p>=n.p+n.d.length)a(e,{d:t.d,p:t.p-n.d.length});else if(t.p+t.d.length<=n.p)a(e,t);else{u={d:"",p:t.p},t.p<n.p&&(u.d=t.d.slice(0,n.p-t.p)),t.p+t.d.length>n.p+n.d.length&&(u.d+=t.d.slice(n.p+n.d.length-t.p)),o=Math.max(t.p,n.p),s=Math.min(t.p+t.d.length,n.p+n.d.length),i=t.d.slice(o-t.p,s-t.p),f=n.d.slice(o-n.p,s-n.p);if(i!==f)throw new Error("Delete ops delete different text in the same region of the document");u.d!==""&&(u.p=E(u.p,n),a(e,u))}return e},v=function(e){return e.i!=null?{d:e.i,p:e.p}:{i:e.d,p:e.p}},b.invert=function(e){var t,n,r,i=e.slice().reverse(),s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(v(t));return s},h.types||(h.types={}),f(b,w,c,a),h.types.text=b,b.api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(e,t,n){var r=[{p:e,i:t}];return this.submitOp(r,n),r},del:function(e,t,n){var r=[{p:e,d:this.snapshot.slice(e,e+t)}];return this.submitOp(r,n),r},_register:function(){return this.on("remoteop",function(e){var t,n,r,i=[];for(n=0,r=e.length;n<r;n++)t=e[n],t.i!==void 0?i.push(this.emit("insert",t.p,t.i)):i.push(this.emit("delete",t.p,t.d));return i})}},h.extendDoc=function(e,t){return n.prototype[e]=t},n=function(){function e(e,t,n){this.connection=e,this.name=t,this.shout=T(this.shout,this),this.flush=T(this.flush,this),n||(n={}),this.version=n.v,this.snapshot=n.snaphot,n.type&&this._setType(n.type),this.state="closed",this.autoOpen=!1,this._create=n.create,this.inflightOp=null,this.inflightCallbacks=[],this.inflightSubmittedIds=[],this.pendingOp=null,this.pendingCallbacks=[],this.serverOps={}}return e.prototype._xf=function(e,t){var n,r;return this.type.transformX?this.type.transformX(e,t):(n=this.type.transform(e,t,"left"),r=this.type.transform(t,e,"right"),[n,r])},e.prototype._otApply=function(e,t){var n=this.snapshot;this.snapshot=this.type.apply(this.snapshot,e),this.emit("change",e,n);if(t)return this.emit("remoteop",e,n)},e.prototype._connectionStateChanged=function(e,t){switch(e){case"disconnected":this.state="closed",this.inflightOp&&this.inflightSubmittedIds.push(this.connection.id),this.emit("closed");break;case"ok":this.autoOpen&&this.open();break;case"stopped":typeof this._openCallback=="function"&&this._openCallback(t)}return this.emit(e,t)},e.prototype._setType=function(e){var t,n,r;if(this.type)return;typeof e=="string"&&(e=S[e]);if(!e||!e.compose)throw new Error("Support for types without compose() is not implemented");this.type=e;if(e.api){r=e.api;for(t in r)n=r[t],this[t]=n;return typeof this._register=="function"?this._register():void 0}return this.provides={}},e.prototype._onMessage=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;switch(!1){case e.open!==!0:return this.state="open",this._create=!1,this.created==null&&(this.created=!!e.create),e.type&&this._setType(e.type),e.create?(this.created=!0,this.snapshot=this.type.create()):(this.created!==!0&&(this.created=!1),e.snapshot!==void 0&&(this.snapshot=e.snapshot)),e.meta&&(this.meta=e.meta),e.v!=null&&(this.version=e.v),this.inflightOp?(u={doc:this.name,op:this.inflightOp,v:this.version},this.inflightSubmittedIds.length&&(u.dupIfSource=this.inflightSubmittedIds),this.connection.send(u)):this.flush(),this.emit("open"),typeof this._openCallback=="function"?this._openCallback(null):void 0;case e.open!==!1:return e.error&&(typeof console!="undefined"&&console!==null&&console.error("Could not open document: "+e.error),this.emit("error",e.error),typeof this._openCallback=="function"&&this._openCallback(e.error)),this.state="closed",this.emit("closed"),typeof this._closeCallback=="function"&&this._closeCallback(),this._closeCallback=null;case e.op!==null||r!=="Op already submitted":break;case!(e.op===void 0&&e.v!==void 0||e.op&&(d=e.meta.source,N.call(this.inflightSubmittedIds,d)>=0)):i=this.inflightOp,this.inflightOp=null,this.inflightSubmittedIds.length=0,r=e.error;if(r){this.type.invert?(a=this.type.invert(i),this.pendingOp&&(v=this._xf(this.pendingOp,a),this.pendingOp=v[0],a=v[1]),this._otApply(a,!0)):this.emit("error","Op apply failed ("+r+") and the op could not be reverted"),m=this.inflightCallbacks;for(l=0,h=m.length;l<h;l++)t=m[l],t(r)}else{if(e.v!==this.version)throw new Error("Invalid version from server");this.serverOps[this.version]=i,this.version++,this.emit("acknowledge",i),g=this.inflightCallbacks;for(c=0,p=g.length;c<p;c++)t=g[c],t(null,i)}return this.flush();case!e.op:if(e.v<this.version)return;if(e.doc!==this.name)return this.emit("error","Expected docName '"+this.name+"' but got "+e.doc);if(e.v!==this.version)return this.emit("error","Expected version "+this.version+" but got "+e.v);return s=e.op,this.serverOps[this.version]=s,n=s,this.inflightOp!==null&&(y=this._xf(this.inflightOp,n),this.inflightOp=y[0],n=y[1]),this.pendingOp!==null&&(b=this._xf(this.pendingOp,n),this.pendingOp=b[0],n=b[1]),this.version++,this._otApply(n,!0);case!e.meta:w=e.meta,o=w.path,f=w.value;switch(o!=null?o[0]:void 0){case"shout":return this.emit("shout",f);default:return typeof console!="undefined"&&console!==null?console.warn("Unhandled meta op:",e):void 0}break;default:return typeof console!="undefined"&&console!==null?console.warn("Unhandled document message:",e):void 0}},e.prototype.flush=function(){if(this.connection.state!=="ok"||this.inflightOp!==null||this.pendingOp===null)return;return this.inflightOp=this.pendingOp,this.inflightCallbacks=this.pendingCallbacks,this.pendingOp=null,this.pendingCallbacks=[],this.connection.send({doc:this.name,op:this.inflightOp,v:this.version})},e.prototype.submitOp=function(e,t){return this.type.normalize!=null&&(e=this.type.normalize(e)),this.snapshot=this.type.apply(this.snapshot,e),this.pendingOp!==null?this.pendingOp=this.type.compose(this.pendingOp,e):this.pendingOp=e,t&&this.pendingCallbacks.push(t),this.emit("change",e),setTimeout(this.flush,0)},e.prototype.shout=function(e){return this.connection.send({doc:this.name,meta:{path:["shout"],value:e}})},e.prototype.open=function(e){var t;this.autoOpen=!0;if(this.state!=="closed")return;return t={doc:this.name,open:!0},this.snapshot===void 0&&(t.snapshot=null),this.type&&(t.type=this.type.name),this.version!=null&&(t.v=this.version),this._create&&(t.create=!0),this.connection.send(t),this.state="opening",this._openCallback=function(t){return function(n){return t._openCallback=null,typeof e=="function"?e(n):void 0}}(this)},e.prototype.close=function(e){return this.autoOpen=!1,this.state==="closed"?typeof e=="function"?e():void 0:(this.connection.send({doc:this.name,open:!1}),this.state="closed",this.emit("closing"),this._closeCallback=e)},e}(),i.mixin(n),h.Doc=n,s=function(){function i(t){this._disconnect=T(this._disconnect,this),this._removeEventListeners=T(this._removeEventListeners,this),this._handleWebsocketError=T(this._handleWebsocketError,this),this._handleWebsocketMessage=T(this._handleWebsocketMessage,this),this._handleWebsocketClose=T(this._handleWebsocketClose,this),this._handleWebsocketOpen=T(this._handleWebsocketOpen,this),this._connect=T(this._connect,this),this._periodicHealthCheck=T(this._periodicHealthCheck,this),this._checkHeartbeat=T(this._checkHeartbeat,this),this._reconnect=T(this._reconnect,this),this.debug=this.debugAll,this.forcedClose=!1,this.url=t,this.readyState=u.CONNECTING,this.URL=t,this.healthCheckInterval=setInterval(this._periodicHealthCheck,e),this._connect()}var e=1e4,t=1,n=2,r=3;return i.prototype.debugAll=!1,i.prototype.onopen=function(){},i.prototype.onclose=function(){},i.prototype.onconnecting=function(){},i.prototype.onmessage=function(){},i.prototype.onerror=function(){},i.prototype.send=function(e){if(this.ws)return this.debug&&console.log("ReconnectingWebSocket","send",this.url,e),this.ws.send(e);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},i.prototype.close=function(){if(this.ws)return this.forcedClose=!0,this.ws.close()},i.prototype.refresh=function(){return this.debug&&console.log("ReconnectingWebSocket","refresh"),this._reconnect()},i.prototype._reconnect=function(){return this.debug&&console.log("ReconnectingWebSocket","reconnect"),!this.ws||this.ws.readyState===u.CLOSED?this._connect():(this._disconnect(),this._connect())},i.prototype._checkHeartbeat=function(){return this.heartbeatResponse===n?(this.debug&&console.log("ReconnectingWebSocket","no-heartbeat"),this._reconnect()):(this.heartbeatResponse=n,this.debug&&console.log("ReconnectingWebSocket","send-heartbeat"),this.send(JSON.stringify("heartbeat")))},i.prototype._periodicHealthCheck=function(){this.debug&&console.log("ReconnectingWebSocket","healthcheck");switch(this.readyState){case u.CLOSED:return this._reconnect();case u.CONNECTING:return this._reconnect();case u.OPEN:return this._checkHeartbeat()}},i.prototype._connect=function(){return this.ws=new u(this.url),this.readyState=u.CONNECTING,this.debug&&console.log("ReconnectingWebSocket","attempt-connect",this.url),this.ws.addEventListener("open",this._handleWebsocketOpen),this.ws.addEventListener("close",this._handleWebsocketClose),this.ws.addEventListener("message",this._handleWebsocketMessage),this.ws.addEventListener("error",this._handleWebsocketError)},i.prototype._handleWebsocketOpen=function(e){return this.debug&&console.log("ReconnectingWebSocket","onopen",this.url),this.readyState=u.OPEN,this.heartbeatResponse=t,this.onopen(e)},i.prototype._handleWebsocketClose=function(e){this.ws=null,this.readyState=u.CLOSED,this.onclose(e);if(this.forcedClose)return clearInterval(this.healthCheckInterval)},i.prototype._handleWebsocketMessage=function(e){var t=JSON.parse(e.data);return this.debug&&console.log("ReconnectingWebSocket","onmessage",this.url,e.data),t.heartbeat?(this.debug&&console.log("ReconnectingWebSocket","heartbeat-received",t.heartbeat),this.heartbeatResponse=r):this.onmessage(e)},i.prototype._handleWebsocketError=function(e){return this.debug&&console.log("ReconnectingWebSocket","onerror",this.url,e),this.onerror(e)},i.prototype._removeEventListeners=function(){this.debug&&console.log("ReconnectingWebSocket","remove-event-listeners");if(this.ws)return this.ws.removeEventListener("open",this._handleWebsocketOpen),this.ws.removeEventListener("close",this._handleWebsocketClose),this.ws.removeEventListener("message",this._handleWebsocketMessage),this.ws.removeEventListener("error",this._handleWebsocketError)},i.prototype._disconnect=function(){this.debug&&console.log("ReconnectingWebSocket","disconnect");if(this.ws)return this._removeEventListeners(),this.ws.close(),this.readyState=u.CLOSED,this.onclose({target:this,type:"disconnect"})},i}(),r=function(){function i(e){this._disconnect=T(this._disconnect,this),this._removeMaintainConnectionTimeout=T(this._removeMaintainConnectionTimeout,this),this._removeEventListeners=T(this._removeEventListeners,this),this._handleWebsocketError=T(this._handleWebsocketError,this),this._handleWebsocketMessage=T(this._handleWebsocketMessage,this),this._handleWebsocketClose=T(this._handleWebsocketClose,this),this._handleWebsocketOpen=T(this._handleWebsocketOpen,this),this._handleVisibilityChange=T(this._handleVisibilityChange,this),this._connect=T(this._connect,this),this._maintainConnection=T(this._maintainConnection,this),this._checkHeartbeat=T(this._checkHeartbeat,this),this._reconnect=T(this._reconnect,this),this.debug=this.debugAll,this.forcedClose=!1,this.url=e,this.readyState=u.CONNECTING,this.URL=e,document.addEventListener("visibilitychange",this._handleVisibilityChange),this._connect()}var e=1e4,t=1,n=2,r=3;return i.prototype.debugAll=!0,i.prototype.onopen=function(){},i.prototype.onclose=function(){},i.prototype.onconnecting=function(){},i.prototype.onmessage=function(){},i.prototype.onerror=function(){},i.prototype.send=function(e){if(this.ws)return this.debug&&console.log("ManagedWebSocket","send",this.url,e),this.ws.send(e);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},i.prototype.close=function(){if(this.ws)return this.forcedClose=!0,this.ws.close()},i.prototype.refresh=function(){return this.debug&&console.log("ManagedWebSocket","refresh"),this._reconnect()},i.prototype._reconnect=function(){return this.debug&&console.log("ManagedWebSocket","reconnect"),!this.ws||this.ws.readyState===u.CLOSED?this._connect():(this._disconnect(),this._connect())},i.prototype._checkHeartbeat=function(){return this.heartbeatResponse===n?(this.debug&&console.log("ManagedWebSocket","no-heartbeat"),this._reconnect()):(this.heartbeatResponse=n,this.debug&&console.log("ManagedWebSocket","send-heartbeat"),this.send(JSON.stringify("heartbeat")))},i.prototype._maintainConnection=function(){this.debug&&console.log("ManagedWebSocket","healthcheck");switch(this.readyState){case u.CLOSED:this._reconnect();break;case u.CONNECTING:this._reconnect();break;case u.OPEN:this._checkHeartbeat()}return this.maintainConnectionTimeout=setTimeout(this._maintainConnection,e)},i.prototype._connect=function(){return this.ws=new u(this.url),this.readyState=u.CONNECTING,this.debug&&console.log("ManagedWebSocket","attempt-connect",this.url),this.ws.addEventListener("open",this._handleWebsocketOpen),this.ws.addEventListener("close",this._handleWebsocketClose),this.ws.addEventListener("message",this._handleWebsocketMessage),this.ws.addEventListener("error",this._handleWebsocketError)},i.prototype._handleVisibilityChange=function(){switch(document.visibilityState){case"visible":return this._maintainConnection();case"hidden":return this._disconnect()}},i.prototype._handleWebsocketOpen=function(e){return this.debug&&console.log("ManagedWebSocket","onopen",this.url),this.readyState=u.OPEN,this.heartbeatResponse=t,this.onopen(e)},i.prototype._handleWebsocketClose=function(e){this.ws=null,this.readyState=u.CLOSED,this.onclose(e);if(this.forcedClose)return clearInterval(this.healthCheckInterval)},i.prototype._handleWebsocketMessage=function(e){var t=JSON.parse(e.data);return this.debug&&console.log("ManagedWebSocket","onmessage",this.url,e.data),t.heartbeat?(this.debug&&console.log("ManagedWebSocket","heartbeat-received",t.heartbeat),this.heartbeatResponse=r):this.onmessage(e)},i.prototype._handleWebsocketError=function(e){return this.debug&&console.log("ManagedWebSocket","onerror",this.url,e),this.onerror(e)},i.prototype._removeEventListeners=function(){this.debug&&console.log("ManagedWebSocket","remove-event-listeners");if(this.ws)return this.ws.removeEventListener("open",this._handleWebsocketOpen),this.ws.removeEventListener("close",this._handleWebsocketClose),this.ws.removeEventListener("message",this._handleWebsocketMessage),this.ws.removeEventListener("error",this._handleWebsocketError)},i.prototype._removeMaintainConnectionTimeout=function(){return clearTimeout(this.maintainConnectionTimeout)},i.prototype._disconnect=function(){this.debug&&console.log("ManagedWebSocket","disconnect");if(this.ws)return this._removeEventListeners(),this._removeMaintainConnectionTimeout(),this.ws.close(),this.readyState=u.CLOSED,this.onclose({target:this,type:"disconnect"})},i}(),S=h.types,e=window.BCSocket,o=window.SockJS,u=window.WebSocket,e?g="channel":o?g="sockjs":g="websocket",t=function(){function t(t,n,i){this.docs={},this.state="connecting",t.match(/^wss?:/)&&(g="websocket"),i&&(g=i),this.socket=function(){switch(g){case"channel":return new e(t,{reconnect:!0});case"sockjs":return new s(t,o);case"websocket":return new s(t);case"managedwebsocket":return new r(t);default:return new e(t,{reconnect:!0})}}(),this.socket.onmessage=function(e){return function(t){var n;if(g==="sockjs"||g==="websocket"||g==="managedwebsocket")t=JSON.parse(t.data);if(t.auth===null)return e.lastError=t.error,e.disconnect(),e.emit("connect failed",t.error);if(t.auth){e.id=t.auth,e.setState("ok");return}return n=t.doc,n!==void 0?e.lastReceivedDoc=n:t.doc=n=e.lastReceivedDoc,e.docs[n]?e.docs[n]._onMessage(t):typeof console!="undefined"&&console!==null?console.error("Unhandled message",t):void 0}}(this),this.connected=!1,this.socket.onclose=function(e){return function(t){e.setState("disconnected",t);if(t==="Closed"||t==="Stopped by server")return e.setState("stopped",e.lastError||t)}}(this),this.socket.onerror=function(e){return function(t){return e.emit("error",t)}}(this),this.socket.onopen=function(e){return function(){return e.send({auth:n?n:null}),e.lastError=e.lastReceivedDoc=e.lastSentDoc=null,e.setState("handshaking")}}(this),this.socket.onconnecting=function(e){return function(){return e.setState("connecting")}}(this)}return t.prototype.setState=function(e,t){var n,r,i,s;if(this.state===e)return;this.state=e,e==="disconnected"&&delete this.id,this.emit(e,t),i=this.docs,s=[];for(r in i)n=i[r],s.push(n._connectionStateChanged(e,t));return s},t.prototype.send=function(e){var t;e.doc&&(t=e.doc,t===this.lastSentDoc?delete e.doc:this.lastSentDoc=t);if(g==="sockjs"||g==="websocket"||g==="managedwebsocket")e=JSON.stringify(e);return this.socket.send(e)},t.prototype.disconnect=function(){return this.socket.close()},t.prototype.makeDoc=function(e,t,r){var i;if(this.docs[e])throw new Error("Doc "+e+" already open");return i=new n(this,e,t),this.docs[e]=i,i.open(function(t){return function(n){return n&&delete t.docs[e],n||i.on("closed",function(){if(!i.autoOpen)return delete t.docs[e]}),r(n,n?void 0:i)}}(this))},t.prototype.openExisting=function(e,t){var n;return this.state==="stopped"?t("connection closed"):this.docs[e]?this._ensureOpenState(this.docs[e],t):n=this.makeDoc(e,{},t)},t.prototype.open=function(e,t,n){var r;if(this.state==="stopped")return n("connection closed");if(this.state==="connecting"){this.on("handshaking",function(){return this.open(e,t,n),n=null});return}typeof t=="function"&&(n=t,t="text"),n||(n=function(){}),typeof t=="string"&&(t=S[t]);if(!t)throw new Error("OT code for document type missing");if(e==null)throw new Error("Server-generated random doc names are not currently supported");if(this.docs[e]){r=this.docs[e],r.type===t?this._ensureOpenState(r,n):n("Type mismatch",r);return}return this.makeDoc(e,{create:!0,type:t.name},n)},t.prototype._ensureOpenState=function(e,t){switch(e.state){case"open":t(null,e);break;case"opening":this.on("open",function(){return t(null,e)});break;case"closed":e.open(function(n){return t(n,n?void 0:e)})}},t}(),i.mixin(t),h.Connection=t,p=window.BCSocket!==void 0,d=window.SockJS!==void 0,p?g="channel":d?g="sockjs":g="websocket",h.open=function(){var e={},n=function(n,r){var i,s,o,u;return n==null&&(o=window.location,u=g==="websocket"?"ws:":o.protocol,n=""+u+"//"+o.host+"/"+g),e[n]||(i=new t(n,r),s=function(){return delete e[n]},i.on("disconnected",s),i.on("connect failed",s),e[n]=i),e[n]},r=function(e){var t,n,r=0,i=e.docs;for(n in i)t=i[n],(t.state!=="closed"||t.autoOpen)&&r++;if(r===0)return e.disconnect()};return function(e,t,i,s){var o,u,a;return typeof i=="function"&&(s=i,i={}),typeof i=="string"&&(i={origin:i}),a=i.origin,o=i.authentication,u=n(a,o),u.open(e,t,function(e,t){return e?(s(e),r(u)):(t.on("closed",function(){return r(u)}),s(null,t))}),u.on("connect failed"),u}}()}).call(this)